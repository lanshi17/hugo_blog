<!-- 加载 Fuse.js 库 -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>

<script>
    // 防抖函数
    const debounce = (func, delay = 300) => {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    };

    // 转义 HTML 特殊字符，防止 XSS
    const escapeHtml = (text) => {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    };

    // 全局变量
    let fuse = null;
    let searchData = [];
    let isRendering = false; // 防止重复渲染

    // 初始化搜索
    document.addEventListener('DOMContentLoaded', async () => {
        const searchInput = document.getElementById('searchQuery');
        const searchResults = document.getElementById('searchResults');
        const resultCount = document.getElementById('resultCount');
        const searchTime = document.getElementById('searchTime');
        const clearButton = document.getElementById('clearSearch');

        // 清除按钮功能
        if (clearButton) {
            clearButton.addEventListener('click', () => {
                searchInput.value = '';
                clearButton.style.display = 'none';
                searchResults.innerHTML = `
                    <div class="search-initial-state">
                        <svg class="initial-icon" xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <h3>开始搜索</h3>
                        <p>输入关键词即可开始搜索文章、笔记和学习资源</p>
                        <div class="quick-search-tags">
                            <span class="quick-tag">Python</span>
                            <span class="quick-tag">数据库</span>
                            <span class="quick-tag">机器学习</span>
                            <span class="quick-tag">算法</span>
                            <span class="quick-tag">Linux</span>
                        </div>
                    </div>
                `;
                resultCount.textContent = '0';
                searchTime.textContent = '0';
                searchInput.focus();
                // 重新绑定快速标签
                bindQuickTags();
            });
        }

        // 监听输入，显示/隐藏清除按钮
        searchInput.addEventListener('input', (e) => {
            if (clearButton) {
                clearButton.style.display = e.target.value ? 'flex' : 'none';
            }
        });

        // 快速标签点击功能
        const bindQuickTags = () => {
            document.querySelectorAll('.quick-tag').forEach(tag => {
                tag.addEventListener('click', () => {
                    searchInput.value = tag.textContent;
                    if (clearButton) clearButton.style.display = 'flex';
                    performSearch(tag.textContent);
                });
            });
        };

        try {
            // 加载搜索数据
            const startTime = performance.now();
            const response = await fetch('/index.json');
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            searchData = await response.json();
            const loadTime = Math.round(performance.now() - startTime);

            // 初始化 Fuse.js
            fuse = new Fuse(searchData, {
                keys: ['title', 'content', 'summary'],
                threshold: 0.3,
                distance: 100,
                minMatchCharLength: 2,
                includeScore: true,
                includeMatches: true,
                ignoreLocation: true
            });

            console.log(`搜索索引加载完成 (${loadTime}ms), 共 ${searchData.length} 条记录`);

            // 搜索处理函数
            const performSearch = (query) => {
                // 防止重复渲染
                if (isRendering) {
                    return;
                }

                if (!query || query.trim().length < 2) {
                    // 清空结果，显示初始状态
                    requestAnimationFrame(() => {
                        searchResults.style.opacity = '0';
                        setTimeout(() => {
                            searchResults.innerHTML = `
                                <div class="search-initial-state">
                                    <svg class="initial-icon" xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <path d="m21 21-4.35-4.35"></path>
                                    </svg>
                                    <h3>开始搜索</h3>
                                    <p>输入关键词即可开始搜索文章、笔记和学习资源</p>
                                    <div class="quick-search-tags">
                                        <span class="quick-tag">Python</span>
                                        <span class="quick-tag">数据库</span>
                                        <span class="quick-tag">机器学习</span>
                                        <span class="quick-tag">算法</span>
                                        <span class="quick-tag">Linux</span>
                                    </div>
                                </div>
                            `;
                            searchResults.style.opacity = '1';
                            bindQuickTags();
                        }, 150);
                    });
                    resultCount.textContent = '0';
                    searchTime.textContent = '0';
                    return;
                }

                isRendering = true;

                // 先淡出
                searchResults.style.opacity = '0';

                // 等待淡出完成后再渲染新内容
                setTimeout(() => {
                    const searchStart = performance.now();
                    const results = fuse.search(query.trim());
                    const searchDuration = Math.round(performance.now() - searchStart);

                    // 更新统计信息
                    resultCount.textContent = results.length;
                    searchTime.textContent = searchDuration;

                    // 渲染结果
                    if (results.length === 0) {
                        searchResults.innerHTML = `
                            <div class="no-results">
                                <p>未找到匹配 "${escapeHtml(query)}" 的内容</p>
                                <p>建议：</p>
                                <ul>
                                    <li>尝试使用不同的关键词</li>
                                    <li>使用更通用的搜索词</li>
                                    <li>检查拼写是否正确</li>
                                </ul>
                            </div>
                        `;
                    } else {
                        const resultHTML = results.map(result => {
                            const item = result.item;
                            let summary = item.summary || item.content || '';
                            
                            // 截取摘要长度
                            if (summary.length > 150) {
                                summary = summary.substring(0, 150) + '...';
                            }

                            // 转义所有文本内容
                            const safeTitle = escapeHtml(item.title);
                            const safeSummary = escapeHtml(summary);
                            const safePermalink = escapeHtml(item.permalink);

                            return `
                                <article class="search-result-item">
                                    <h3 class="result-title">
                                        <a href="${safePermalink}">${safeTitle}</a>
                                    </h3>
                                    <p class="result-summary">${safeSummary}</p>
                                    <div class="result-meta">
                                        <span class="result-score">匹配度: ${(1 - result.score).toFixed(2)}</span>
                                    </div>
                                </article>
                            `;
                        }).join('');

                        searchResults.innerHTML = resultHTML;
                    }

                    // 淡入新内容
                    requestAnimationFrame(() => {
                        searchResults.style.opacity = '1';
                        isRendering = false;
                    });
                }, 150); // 等待淡出动画完成
            };

            // 绑定搜索事件（带防抖）
            searchInput.addEventListener('input', debounce((e) => {
                performSearch(e.target.value);
            }, 400)); // 增加防抖延迟，减少频繁渲染

            // 绑定初始快速标签
            bindQuickTags();

            // 如果 URL 中有搜索参数，自动执行搜索
            const urlParams = new URLSearchParams(window.location.search);
            const queryParam = urlParams.get('q');
            if (queryParam) {
                searchInput.value = queryParam;
                if (clearButton) clearButton.style.display = 'flex';
                performSearch(queryParam);
            }

        } catch (err) {
            console.error('Search init failed:', err);
            searchResults.innerHTML = `
                <div class="error-message">
                    <p>❌ 搜索功能初始化失败</p>
                    <p>错误信息: ${escapeHtml(err.message)}</p>
                    <p>请刷新页面重试</p>
                </div>
            `;
        }
    });
</script>

<style>
    /* ==================== 搜索页面整体布局 ==================== */
    .search-page-wrapper {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    /* 搜索头部 */
    .search-header {
        text-align: center;
        margin-bottom: 3rem;
        padding-bottom: 2rem;
        border-bottom: 2px solid var(--border);
    }

    .search-title-section {
        animation: fadeInDown 0.6s ease-out;
    }

    .search-page-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0 0 0.5rem 0;
        color: var(--primary);
        letter-spacing: -0.5px;
    }

    .search-page-subtitle {
        font-size: 1.1rem;
        color: var(--secondary);
        margin: 0;
        font-weight: 400;
    }

    /* ==================== 搜索输入区域 ==================== */
    .search-input-wrapper {
        margin-bottom: 2rem;
    }

    .search-box {
        position: relative;
        display: flex;
        align-items: center;
        background: var(--entry);
        border: 2px solid var(--border);
        border-radius: 12px;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .search-box:focus-within {
        border-color: var(--primary);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .search-icon {
        color: var(--secondary);
        margin-right: 0.75rem;
        flex-shrink: 0;
    }

    .search-input {
        flex: 1;
        border: none;
        background: transparent;
        color: var(--primary);
        font-size: 1.1rem;
        outline: none;
        padding: 0;
    }

    .search-input::placeholder {
        color: var(--tertiary);
    }

    .clear-button {
        background: none;
        border: none;
        color: var(--secondary);
        cursor: pointer;
        padding: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .clear-button:hover {
        background: var(--theme);
        color: var(--primary);
    }

    /* 搜索提示标签 */
    .search-tips {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1rem;
        flex-wrap: wrap;
    }

    .tip-item {
        font-size: 0.875rem;
        color: var(--secondary);
        padding: 0.4rem 0.8rem;
        background: var(--code-bg);
        border-radius: 20px;
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
    }

    /* ==================== 搜索统计信息 ==================== */
    .search-stats {
        display: flex;
        gap: 2rem;
        justify-content: center;
        align-items: center;
        margin-bottom: 2rem;
        padding: 1rem;
        background: var(--code-bg);
        border-radius: 8px;
        flex-wrap: wrap;
    }

    .stats-item {
        display: flex;
        align-items: baseline;
        gap: 0.4rem;
    }

    .stats-label {
        font-size: 0.9rem;
        color: var(--secondary);
    }

    .stats-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--primary);
    }

    .stats-unit {
        font-size: 0.875rem;
        color: var(--tertiary);
    }

    /* ==================== 搜索结果容器 ==================== */
    .search-results-container {
        opacity: 1;
        transition: opacity 0.15s ease-in-out;
        min-height: 200px;
        will-change: opacity;
    }

    /* 初始状态 */
    .search-initial-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--secondary);
    }

    .initial-icon {
        color: var(--tertiary);
        margin-bottom: 1.5rem;
        opacity: 0.5;
    }

    .search-initial-state h3 {
        font-size: 1.5rem;
        color: var(--primary);
        margin: 0 0 0.5rem 0;
    }

    .search-initial-state p {
        font-size: 1rem;
        margin: 0 0 1.5rem 0;
    }

    .quick-search-tags {
        display: flex;
        gap: 0.75rem;
        justify-content: center;
        flex-wrap: wrap;
    }

    .quick-tag {
        padding: 0.5rem 1rem;
        background: var(--entry);
        border: 1px solid var(--border);
        border-radius: 20px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        color: var(--primary);
    }

    .quick-tag:hover {
        background: var(--primary);
        color: var(--theme);
        border-color: var(--primary);
        transform: translateY(-2px);
    }

    /* ==================== 搜索结果项 ==================== */
    .search-result-item {
        padding: 1.5rem;
        margin-bottom: 1.25rem;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--entry);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        clear: both;
    }

    .search-result-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: linear-gradient(to bottom, var(--primary), var(--tertiary));
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .search-result-item:hover {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        transform: translateY(-4px);
        border-color: var(--primary);
    }

    .search-result-item:hover::before {
        opacity: 1;
    }

    /* 标题样式 */
    .result-title {
        margin: 0 0 0.75rem 0;
        font-size: 1.25rem;
        font-weight: 600;
        line-height: 1.4;
        position: relative;
        z-index: 1;
        display: block;
        clear: both;
    }

    .result-title a {
        color: var(--primary);
        text-decoration: none;
        display: inline-block;
        backface-visibility: hidden;
        -webkit-font-smoothing: antialiased;
        transition: color 0.2s ease;
    }

    .result-title a:hover {
        color: var(--tertiary);
    }

    /* 摘要样式 */
    .result-summary {
        color: var(--secondary);
        margin: 0 0 1rem 0;
        line-height: 1.7;
        display: block;
        word-wrap: break-word;
        word-break: break-word;
        font-size: 0.95rem;
    }

    /* 元信息 */
    .result-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.875rem;
        color: var(--tertiary);
        align-items: center;
        flex-wrap: wrap;
    }

    .result-score {
        padding: 0.3rem 0.75rem;
        background: var(--code-bg);
        border-radius: 20px;
        display: inline-flex;
        align-items: center;
        font-weight: 500;
    }

    /* ==================== 无结果状态 ==================== */
    .no-results, .error-message {
        padding: 3rem 2rem;
        text-align: center;
        color: var(--secondary);
        animation: fadeIn 0.3s ease-in;
        background: var(--entry);
        border-radius: 12px;
        border: 1px dashed var(--border);
    }

    .no-results p {
        margin: 0.5rem 0;
    }

    .no-results ul {
        text-align: left;
        display: inline-block;
        margin-top: 1.5rem;
        list-style: none;
        padding: 0;
    }

    .no-results ul li {
        padding: 0.5rem 0;
        position: relative;
        padding-left: 1.5rem;
    }

    .no-results ul li::before {
        content: '→';
        position: absolute;
        left: 0;
        color: var(--primary);
    }

    /* 错误消息 */
    .error-message {
        background: #fee;
        border: 2px solid #fcc;
        color: #c00;
    }

    /* ==================== 动画 ==================== */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* ==================== 响应式设计 ==================== */
    @media (max-width: 768px) {
        .search-page-wrapper {
            padding: 1.5rem 1rem;
        }

        .search-page-title {
            font-size: 2rem;
        }

        .search-page-subtitle {
            font-size: 1rem;
        }

        .search-header {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
        }

        .search-box {
            padding: 0.65rem 0.85rem;
        }

        .search-input {
            font-size: 1rem;
        }

        .search-tips {
            gap: 0.5rem;
        }

        .tip-item {
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
        }

        .search-stats {
            gap: 1rem;
            padding: 0.75rem;
        }

        .search-result-item {
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .result-title {
            font-size: 1.1rem;
        }

        .result-summary {
            font-size: 0.9rem;
        }

        .quick-search-tags {
            gap: 0.5rem;
        }

        .quick-tag {
            padding: 0.4rem 0.75rem;
            font-size: 0.8rem;
        }
    }

    @media (max-width: 480px) {
        .search-page-title {
            font-size: 1.75rem;
        }

        .search-stats {
            flex-direction: column;
            gap: 0.5rem;
        }

        .search-tips {
            flex-direction: column;
            align-items: stretch;
        }

        .tip-item {
            text-align: center;
        }
    }
</style>